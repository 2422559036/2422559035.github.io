<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°é¢è®¾è®¡è®¢å•æŸ¥è¯¢ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", Arial, sans-serif;
        }
        body {
            background-color: #f8f9fa;
            padding: 30px 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }
        h1 {
            color: #007bff;
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        input {
            padding: 12px 15px;
            width: 100%;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        .tips {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
            font-style: italic;
        }
        #query-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 14px;
            width: 100%;
            border-radius: 6px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        #query-btn:hover {
            background-color: #218838;
        }
        .query-result {
            margin-top: 25px;
            padding: 20px;
            border-radius: 8px;
            background-color: #e9f7fe;
            border: 1px solid #b3d9f2;
            display: none;
        }
        .query-result h3 {
            color: #007bff;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #b3d9f2;
            text-align: center;
        }
        .query-result p {
            margin-bottom: 12px;
            font-size: 16px;
            line-height: 1.6;
        }
        .query-result p span {
            font-weight: 600;
            color: #212529;
        }
        .queue-number {
            color: #dc3545;
            font-weight: bold;
            font-size: 18px;
        }
        .status-design {
            color: #007bff;
            font-weight: bold;
        }
        .status-queued {
            color: #28a745;
            font-weight: bold;
        }
        .status-waiting {
            color: #ffc107;
            font-weight: bold;
        }
        .status-completed {
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å°é¢è®¾è®¡è®¢å•æŸ¥è¯¢</h1>
        
        <div class="form-group">
            <label>åŒæ­¥ç ï¼ˆè®¾è®¡å¸ˆæä¾›çš„6ä½ç ï¼‰</label>
            <input id="q-code" placeholder="ä¾‹å¦‚ï¼š8A7B9Cï¼ˆå¤§å°å†™å‡å¯ï¼‰">
            <div class="tips">æç¤ºï¼šåŒæ­¥ç ç”±è®¾è®¡å¸ˆç”Ÿæˆå¹¶æä¾›ï¼Œç”¨äºåŒæ­¥æœ€æ–°è®¢å•æ•°æ®</div>
        </div>
        
        <div class="form-group">
            <label>ä½œè€…ç¬”å</label>
            <input id="q-author" placeholder="è¯·è¾“å…¥ä¸‹å•æ—¶å¡«å†™çš„ä½œè€…ç¬”å">
            <div class="tips">æç¤ºï¼šè¯·ä¸ä¸‹å•æ—¶å¡«å†™çš„ç¬”åå®Œå…¨ä¸€è‡´ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰</div>
        </div>
        
        <div class="form-group">
            <label>ä¹¦ç±åç§°</label>
            <input id="q-book" placeholder="è¯·è¾“å…¥ä¸‹å•æ—¶å¡«å†™çš„ä¹¦ç±åç§°">
            <div class="tips">æç¤ºï¼šè¯·ä¸ä¸‹å•æ—¶å¡«å†™çš„ä¹¦åå®Œå…¨ä¸€è‡´ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰</div>
        </div>
        
        <button id="query-btn">ğŸ” ç«‹å³æŸ¥è¯¢è®¢å•</button>
        
        <div class="query-result" id="q-result">
            <h3 id="q-title"></h3>
            <p>è®¢å•ç±»å‹ï¼š<span id="q-type"></span></p>
            <p>æ’é˜Ÿåºå·ï¼š<span id="q-queue" class="queue-number"></span></p>
            <p>é¢„è®¡å‡ºå•æ—¶é—´ï¼š<span id="q-time"></span></p>
            <p>è®¢å•çŠ¶æ€ï¼š<span id="q-status"></span></p>
        </div>
    </div>

    <script>
        // è¯»å–æœ¬åœ°å­˜å‚¨çš„åŒæ­¥ç æ˜ å°„æ•°æ®ï¼ˆä¸åŸæ’å•ç³»ç»Ÿå…±ç”¨ï¼‰
        let syncCodeMap = JSON.parse(localStorage.getItem('syncCodeMap')) || {};

        // å·¥å…·å‡½æ•°ï¼ˆä¿ç•™åŸç³»ç»Ÿçš„æ ¸å¿ƒè®¡ç®—é€»è¾‘ï¼‰
        function fmt(date) {
            return date.toISOString().split('T')[0];
        }
        function addDays(dateStr, n) {
            const d = new Date(dateStr);
            d.setDate(d.getDate() + n);
            return fmt(d);
        }
        function time(dateStr) {
            return new Date(dateStr).getTime();
        }

        // ç»‘å®šæŸ¥è¯¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('query-btn').onclick = () => {
            // æ¸…ç©ºä¹‹å‰çš„æŸ¥è¯¢ç»“æœ
            document.getElementById('q-result').style.display = 'none';
            
            // 1. éªŒè¯åŒæ­¥ç 
            const code = document.getElementById('q-code').value.trim().toUpperCase();
            if (!code) {
                alert('è¯·è¾“å…¥è®¾è®¡å¸ˆæä¾›çš„åŒæ­¥ç ï¼');
                return;
            }

            // 2. éªŒè¯åŒæ­¥ç æ˜¯å¦æœ‰æ•ˆ
            const orderData = syncCodeMap[code];
            if (!orderData) {
                alert('æ— æ•ˆçš„åŒæ­¥ç ï¼Œè¯·æ ¸å¯¹åé‡æ–°è¾“å…¥ï¼');
                return;
            }
            
            // 3. éªŒè¯ä½œè€…å’Œä¹¦ç±åç§°
            const author = document.getElementById('q-author').value.trim();
            const book = document.getElementById('q-book').value.trim();
            if (!author || !book) { 
                alert('ä½œè€…ç¬”åå’Œä¹¦ç±åç§°ä¸èƒ½ä¸ºç©ºï¼'); 
                return; 
            }

            // 4. æŸ¥æ‰¾åŒ¹é…çš„è®¢å•ï¼ˆä¸¥æ ¼åŒ¹é…ï¼Œä¿æŒä¸åŸç³»ç»Ÿä¸€è‡´ï¼‰
            const targetOrder = orderData.find(o =>
                o.authorName.trim() === author &&
                o.bookName.trim() === book
            );
            
            if (!targetOrder) { 
                alert('æœªæ‰¾åˆ°åŒ¹é…çš„è®¢å•ï¼Œè¯·æ ¸å¯¹ä½œè€…ç¬”åå’Œä¹¦ç±åç§°ï¼'); 
                return; 
            }

            // 5. è§£æè®¢å•ä¿¡æ¯å¹¶å±•ç¤º
            // å¤„ç†è®¢å•ç±»å‹
            let typeName = '';
            if (targetOrder.type === 'specified') {
                typeName = 'æŒ‡å®šæ—¥æœŸ';
            } else if (targetOrder.type.startsWith('urgent')) {
                typeName = targetOrder.type.replace('urgent_', 'åŠ æ€¥') + 'å¤©';
            } else {
                typeName = 'æ™®é€šæ’å•';
            }

            // è®¡ç®—æ’é˜Ÿåºå·
            const sortedAll = [...orderData].sort((x,y)=>time(x.expectedTime)-time(y.expectedTime));
            const undoneOrders = sortedAll.filter(x=>!x.completed);
            const queuePos = undoneOrders.findIndex(x=>x.id === targetOrder.id) + 1;

            // å¤„ç†è®¢å•çŠ¶æ€
            let statusText = '';
            let statusClass = '';
            if (targetOrder.completed) {
                statusText = 'å·²å®Œæˆ';
                statusClass = 'status-completed';
            } else {
                if (queuePos === 1) {
                    statusText = 'è®¾è®¡ä¸­';
                    statusClass = 'status-design';
                } else if (queuePos >= 2 && queuePos <= 4) { // åŸé€»è¾‘æ˜¯1-3ä¸ºå·²æ’å•ï¼Œè¿™é‡Œå¯¹åº”pos+1åæ˜¯2-4
                    statusText = 'å·²æ’å•';
                    statusClass = 'status-queued';
                } else {
                    statusText = 'æ’å•ä¸­';
                    statusClass = 'status-waiting';
                }
            }

            // 6. å¡«å……æŸ¥è¯¢ç»“æœ
            document.getElementById('q-title').textContent = `${targetOrder.bookName}ï¼ˆ${targetOrder.authorName}ï¼‰`;
            document.getElementById('q-type').textContent = typeName;
            document.getElementById('q-queue').textContent = targetOrder.completed ? 'å·²å®Œæˆï¼Œæ— éœ€æ’é˜Ÿ' : queuePos;
            document.getElementById('q-time').textContent = targetOrder.completed ? 'å·²å®Œæˆåˆ¶ä½œ' : targetOrder.expectedTime;
            document.getElementById('q-status').textContent = statusText;
            document.getElementById('q-status').className = statusClass;

            // 7. æ˜¾ç¤ºæŸ¥è¯¢ç»“æœ
            document.getElementById('q-result').style.display = 'block';
        };
    </script>
</body>
</html>